//-------------------------------------------------------------------------------------------------
// File : Gui.h
// Desc : Graphical User Interface Helper.
// Copyright(c) Pocol. All right reserved.
//-------------------------------------------------------------------------------------------------
#pragma once

//-------------------------------------------------------------------------------------------------
// Includes
//-------------------------------------------------------------------------------------------------
#include <cstdint>
#include <chrono>
#include <imgui.h>
#include <d3d12.h>
#include <ResourceUploadBatch.h>
#include <DescriptorPool.h>
#include <ConstantBuffer.h>
#include <VertexBuffer.h>
#include <IndexBuffer.h>
#include <Texture.h>


///////////////////////////////////////////////////////////////////////////////////////////////////
// Gui class
///////////////////////////////////////////////////////////////////////////////////////////////////
class Gui
{
    //=============================================================================================
    // list of friend classes and methods.
    //=============================================================================================
    friend void KickDraw(ImDrawData*);

public:
    //=============================================================================================
    // public variables.
    //=============================================================================================
    /* NOTHING */

    //=============================================================================================
    // public methods.
    //=============================================================================================

    //---------------------------------------------------------------------------------------------
    //! @brief      コンストラクタです.
    //---------------------------------------------------------------------------------------------
    Gui();

    //---------------------------------------------------------------------------------------------
    //! @brief      デストラクタです.
    //---------------------------------------------------------------------------------------------
    ~Gui();

    //---------------------------------------------------------------------------------------------
    //! @brief      初期化処理を行います.
    //!
    //! @param[in]      pDevice         デバイスです.
    //! @param[in]      pPool           CBV/SRV用のディスクリプタプールです.
    //! @param[out]     batch           更新バッチです.
    //! @retval true    初期化に成功.
    //! @retval false   初期化に失敗.
    //---------------------------------------------------------------------------------------------
    bool Init(
        ID3D12Device*                 pDevice,
        DescriptorPool*               pPool,
        DXGI_FORMAT                   format,
        HWND                          hWnd,
        DirectX::ResourceUploadBatch& batch);

    //---------------------------------------------------------------------------------------------
    //! @brief      終了処理を行います.
    //---------------------------------------------------------------------------------------------
    void Term();

    //---------------------------------------------------------------------------------------------
    //! @brief      描画処理を行います.
    //!
    //! @param[in]      pCmdList        グラフィックスコマンドリストです.
    //---------------------------------------------------------------------------------------------
    void Draw(ID3D12GraphicsCommandList* pCmdList);

    //---------------------------------------------------------------------------------------------
    //! @brief      バッファを入れ替えます.
    //---------------------------------------------------------------------------------------------
    void SwapBuffers();

    //---------------------------------------------------------------------------------------------
    //! @brief      ウィンドウメッセージを処理します.
    //!
    //! @param[in]      hWnd        ウィンドウハンドルです.
    //! @param[in]      msg         ウィンドウメッセージです.
    //! @param[in]      wp          ウィンドウパラメータです.
    //! @param[in]      lp          ウィンドウパラメータです.
    //---------------------------------------------------------------------------------------------
    void MsgProc(HWND hWnd, UINT msg, WPARAM wp, LPARAM lp);

private:
    //=============================================================================================
    // private variables.
    //=============================================================================================
    const uint32_t  MaxPrimitiveCount = 6 * 1024;

    ConstantBuffer                          m_CB[2];        //!< 定数バッファです.
    VertexBuffer                            m_VB[2];        //!< 頂点バッファです.
    IndexBuffer                             m_IB[2];        //!< インデックスバッファです.
    Texture                                 m_Font;         //!< フォントテクスチャです.
    ComPtr<ID3D12RootSignature>             m_RootSig;      //!< ルートシグニチャです.
    ComPtr<ID3D12PipelineState>             m_PSO;          //!< パイプラインステートです.
    ID3D12GraphicsCommandList*              m_pCmdList;     //!< グラフィックスコマンドリストです.
    int                                     m_Index;        //!< バッファ番号です.
    std::chrono::system_clock::time_point   m_LastTime;     //!< 最後の更新時刻です.

    //=============================================================================================
    // private methods.
    //=============================================================================================

    //---------------------------------------------------------------------------------------------
    //! @brief      描画時の処理です.
    //!
    //! @param[in]      pData       ImGuiの描画データです.
    //---------------------------------------------------------------------------------------------
    void OnDraw(ImDrawData* pData);
};